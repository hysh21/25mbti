import streamlit as st
import pandas as pd
import hashlib

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="MBTI ê¸°ì§ˆë³„ TOP10 ì¹´ë“œë‰´ìŠ¤", page_icon="ğŸ—ºï¸", layout="wide")
st.title("ğŸ—ºï¸ MBTI ê¸°ì§ˆë³„ TOP 10 â€” ì¹´ë“œ ë‰´ìŠ¤ ìŠ¤íƒ€ì¼")
st.caption("NF / NT / SJ / SP / ST ë³„ë¡œ ë¹„ìœ¨ì´ ë†’ì€ ë‚˜ë¼ TOP10ì„ ì¹´ë“œë¡œ ì˜ˆì˜ê²Œ ë³´ì—¬ì¤˜ìš”. âœˆï¸ğŸœğŸ°")

FILE_PATH = "countriesMBTI_16types.csv"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë°ì´í„° ë¡œë“œ & ì „ì²˜ë¦¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def load_data(path: str):
    df = pd.read_csv(path, encoding="utf-8-sig")
    df.columns = df.columns.str.strip()
    if "Country" not in df.columns:
        raise ValueError("CSVì— 'Country' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")

    mbti_cols = [c for c in df.columns if c != "Country"]
    # ìˆ«ìí˜•ìœ¼ë¡œ ê°•ì œ ë³€í™˜
    df[mbti_cols] = df[mbti_cols].apply(pd.to_numeric, errors="coerce").fillna(0.0)
    return df, mbti_cols

try:
    df, mbti_cols = load_data(FILE_PATH)
except Exception as e:
    st.error(f"ë°ì´í„° ë¡œë“œ ì—ëŸ¬: {e}")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ì§ˆ ê·¸ë£¹ ì •ì˜
# SJ(ISTJ, ISFJ, ESTJ, ESFJ), SP(ISTP, ISFP, ESTP, ESFP),
# NF(INFJ, INFP, ENFJ, ENFP), NT(INTJ, INTP, ENTJ, ENTP),
# ST(ISTJ, ESTJ, ISTP, ESTP)  â† SJì™€ SPì— ê±¸ì³ìˆëŠ” ST ë„¤ ê°€ì§€ í•©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GROUPS = {
    "NF": ["INFJ", "INFP", "ENFJ", "ENFP"],
    "NT": ["INTJ", "INTP", "ENTJ", "ENTP"],
    "SJ": ["ISTJ", "ISFJ", "ESTJ", "ESFJ"],
    "SP": ["ISTP", "ISFP", "ESTP", "ESFP"],
    "ST": ["ISTJ", "ESTJ", "ISTP", "ESTP"],
}

# ê° ê·¸ë£¹ í•©ê³„ë¥¼ ì»¬ëŸ¼ìœ¼ë¡œ ì¶”ê°€ (ë¹„ìœ¨ í•©)
for g, cols in GROUPS.items():
    missing = [c for c in cols if c not in df.columns]
    if missing:
        st.error(f"{g} ê·¸ë£¹ì— í•„ìš”í•œ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤: {missing}")
        st.stop()
    df[g] = df[cols].sum(axis=1)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìœ í‹¸: ì´ëª¨ì§€/ìƒ‰ìƒ ì„ íƒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
emoji_pool = [
    "ğŸ–ï¸","ğŸ™ï¸","ğŸ”ï¸","ğŸŒ‹","ğŸœï¸","â›©ï¸","ğŸ°","ğŸ","ğŸŒ‰","ğŸ•Œ","ğŸ›•","ğŸ—¼","ğŸ—½",
    "ğŸŒŠ","ğŸŒ´","â˜•ï¸","ğŸœ","ğŸ£","ğŸ¥","ğŸŒ®","ğŸ«","ğŸ·","ğŸº","ğŸµ","ğŸ§","ğŸ±","ğŸ¥Ÿ"
]
def pick_emojis(key: str, k: int = 2):
    h = int(hashlib.md5(key.encode("utf-8")).hexdigest(), 16)
    e1 = emoji_pool[h % len(emoji_pool)]
    e2 = emoji_pool[(h // 7) % len(emoji_pool)]
    return [e1, e2] if e1 != e2 else [e1, "âœ¨"]

# ë¼ì´íŠ¸í•œ íŒŒìŠ¤í…” ë°±ê·¸ë¼ìš´ë“œë“¤
card_bg_colors = [
    "#FDF2F8", "#ECFEFF", "#F0F9FF", "#F0FDF4", "#FFF7ED",
    "#F5F5F5", "#FDF4FF", "#FEF2F2", "#FAFAF9", "#EFF6FF"
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì¹´ë“œ ë Œë”ëŸ¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_top10_cards(group_key: str):
    """ì„ íƒí•œ ê¸°ì§ˆ ê·¸ë£¹ì˜ TOP10 ë‚˜ë¼ë¥¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ë¡œ ë¿Œë ¤ì¤Œ"""
    if group_key not in GROUPS:
        st.warning("ì•Œ ìˆ˜ ì—†ëŠ” ê·¸ë£¹ì…ë‹ˆë‹¤.")
        return

    # ì •ë ¬ ë° ìƒìœ„ 10ê°œ
    top10 = (
        df[["Country", group_key]]
        .sort_values(group_key, ascending=False)
        .head(10)
        .reset_index(drop=True)
        .rename(columns={"Country": "êµ­ê°€", group_key: "ratio"})
    )
    top10["percent"] = (top10["ratio"] * 100).round(2)

    st.markdown(f"#### ğŸ§­ {group_key}í˜•ì´ ë§ì€ ë‚˜ë¼ TOP 10")
    st.caption("â€» ë¹„ìœ¨ì€ í•´ë‹¹ êµ­ê°€ ì¸êµ¬ ëŒ€ë¹„ í•´ë‹¹ ê¸°ì§ˆ ê·¸ë£¹ í•©ê³„(16ìœ í˜• ì¤‘ í•´ë‹¹ ê·¸ë£¹ 4ìœ í˜•ì˜ í•©)ì…ë‹ˆë‹¤.")

    # 2ì—´ x 5í–‰ ì¹´ë“œ ë°°ì¹˜
    rows = [top10.iloc[i:i+2] for i in range(0, len(top10), 2)]
    for r_i, r_df in enumerate(rows):
        cols = st.columns(2, gap="large")
        for c_idx, (_, row) in enumerate(r_df.iterrows()):
            # ì¹´ë“œ ìŠ¤íƒ€ì¼
            bg = card_bg_colors[(r_i*2 + c_idx) % len(card_bg_colors)]
            medal = ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","4ï¸âƒ£","5ï¸âƒ£","6ï¸âƒ£","7ï¸âƒ£","8ï¸âƒ£","9ï¸âƒ£","ğŸ”Ÿ"][r_i*2 + c_idx]
            e1, e2 = pick_emojis(row["êµ­ê°€"])

            with cols[c_idx]:
                st.markdown(
                    f"""
                    <div style="
                        background:{bg};
                        border-radius:24px;
                        padding:18px 20px;
                        box-shadow: 0 6px 18px rgba(0,0,0,0.05);
                        border:1px solid rgba(0,0,0,0.05);
                    ">
                        <div style="font-size:28px; line-height:1.2; margin-bottom:6px;">
                            {medal} <b>{row['êµ­ê°€']}</b> {e1}{e2}
                        </div>
                        <div style="font-size:16px; color:#555; margin-bottom:6px;">
                            {group_key}í˜• ë¹„ìœ¨
                        </div>
                        <div style="font-size:22px;"><b>{row['percent']}%</b></div>
                    </div>
                    """,
                    unsafe_allow_html=True
                )

    with st.expander("ğŸ” í‘œë¡œ ë³´ê¸°"):
        st.dataframe(
            top10[["êµ­ê°€", "percent"]].rename(columns={"percent": "ë¹„ìœ¨(%)"}),
            use_container_width=True,
            hide_index=True
        )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UI: íƒ­ìœ¼ë¡œ ê·¸ë£¹ë³„ ì¹´ë“œ ë³´ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tabs = st.tabs(["ğŸŒ¸ NF", "ğŸ§  NT", "ğŸ§¾ SJ", "ğŸ’ SP", "ğŸ§­ ST"])

with tabs[0]:
    render_top10_cards("NF")
with tabs[1]:
    render_top10_cards("NT")
with tabs[2]:
    render_top10_cards("SJ")
with tabs[3]:
    render_top10_cards("SP")
with tabs[4]:
    render_top10_cards("ST")

st.markdown("---")
st.caption(
    "ğŸ“Œ ì°¸ê³ : STí˜•(ISTJÂ·ESTJÂ·ISTPÂ·ESTP)ì€ SJ/SPì— ê±¸ì³ìˆëŠ” 4ìœ í˜•ì˜ í•©ê³„ì…ë‹ˆë‹¤. "
    "ëª¨ë“  ê°’ì€ ì œê³µëœ CSVì˜ ë¹„ìœ¨(0~1)ì„ ì‚¬ìš©í•˜ë©°, ì¹´ë“œì˜ %ëŠ” í•´ë‹¹ ë¹„ìœ¨Ã—100ì…ë‹ˆë‹¤. ğŸˆ"
)
